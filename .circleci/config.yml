version: 2.1

job_defaults: &job_defaults
  filters:
    tags:
      only: /.*/
    branches:
      only: /.*/

orbs:
  codecov: codecov/codecov@5.4.3

commands:
  restore_rust_cache:
    steps:
      - restore_cache:
          keys:
            - cargo-cache-{{ checksum "server/Cargo.lock" }}
  save_rust_cache:
    steps:
      - save_cache:
          key: cargo-cache-{{ checksum "server/Cargo.lock" }}
          paths:
            - ~/.cargo
            - server/target/debug
            - server/target/release

jobs:
  test:
    docker:
      - image: cimg/rust:1.89.0
    steps:
      - checkout
      - restore_rust_cache
      - run:
          name: Install cargo tools
          command: |
            cargo install cargo2junit --version 0.1.14
            cargo install cargo-tarpaulin --version 0.32.8
      - run:
          name: Run tests and generate test reports
          command: |
            cd server
            mkdir -p test-results
            RUSTC_BOOTSTRAP=1 cargo test -- -Z unstable-options --format json --report-time | cargo2junit > test-results/junit.xml
            cargo tarpaulin --out Xml --output-dir ./coverage --no-fail-fast
      - store_test_results:
          path: server/test-results
      - codecov/upload
      - save_rust_cache

workflows:
  version: 2
  main:
    jobs:
      - test:
          <<: *job_defaults
