version: 2.1

job_defaults: &job_defaults
  filters:
    tags:
      only: /.*/
    branches:
      only: /.*/

orbs:
  codecov: codecov/codecov@5.4.3

commands:
  restore_rust_cache:
    steps:
      - restore_cache:
          keys:
            - cargo-cache-{{ checksum "server/Cargo.lock" }}
  save_rust_cache:
    steps:
      - save_cache:
          key: cargo-cache-{{ checksum "server/Cargo.lock" }}
          paths:
            - ~/.cargo
            - server/target/debug
            - server/target/release
  save_sccache:
    steps:
      - save_cache:
          key: sccache-v1
          paths:
            - ~/.cache/sccache
  restore_sccache:
    steps:
      - restore_cache:
          keys:
            - sccache-v1
  install_sccache:
    parameters:
      version:
        type: string
        default: "0.10.0"
    steps:
      - run:
          name: Install sccache
          command: |
            SCCACHE_VERSION="<<parameters.version>>"

            curl -L "https://github.com/mozilla/sccache/releases/download/v${SCCACHE_VERSION}/sccache-v${SCCACHE_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/sccache/archive.tar.gz
            tar -xvzf /tmp/sccache/archive.tar.gz -C /tmp/sccache
            sudo mv /tmp/sccache/sccache-dist /usr/local/bin/sccache
            
            # Set environment variables for sccache
            echo 'export RCCACHE_DIR="/tmp/sccache"' >> $BASH_ENV
            echo 'export RCCACHE_SLOPPINESS="time,file_macro,include_file"' >> $BASH_ENV
            source $BASH_ENV
            
            # Verify installation
            sccache --version

jobs:
  test:
    docker:
      - image: cimg/rust:1.89.0
    steps:
      - checkout
      - install_sccache
      - restore_sccache
      - restore_rust_cache
      - run:
          name: Install cargo tools
          command: |
            cargo install cargo2junit --version 0.1.14
            cargo install cargo-tarpaulin --version 0.32.8
      - run:
          name: Run tests and generate test reports
          command: |
            cd server
            mkdir -p test-results
            RUSTC_BOOTSTRAP=1 cargo test -- -Z unstable-options --format json --report-time | cargo2junit > test-results/junit.xml
            cargo tarpaulin --out Xml --output-dir ./coverage --no-fail-fast --engine Llvm
      - save_sccache
      - store_test_results:
          path: server/test-results
      - codecov/upload
      - save_rust_cache

workflows:
  version: 2
  main:
    jobs:
      - test:
          <<: *job_defaults
